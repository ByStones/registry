#!/usr/bin/env node

var Server = require('../server/server.js');
var path = require('path');
var config = require('konphyg')(path.normalize(__dirname + '/../config'));
var Registry = require('../lib/registry');


// configuration
process.env.NODE_ENV = process.env.NODE_ENV || 'testing';

console.log('Loading ' + process.env.NODE_ENV + ' configuration data');

var options = config(process.env.NODE_ENV);

// server setup
var registry = new Registry(options);
var server = new Server(registry, options.app);

// server components
var rootRoutes = require('../lib/routes/root.js');
var packageRoutes = require('../lib/routes/package.js');
var userRoutes = require('../lib/routes/user.js');

server.applyRoutes(rootRoutes);
server.applyRoutes(packageRoutes, registry);
server.applyRoutes(userRoutes, registry);

server.start(options);
