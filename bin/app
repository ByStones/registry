#!/usr/bin/env node

// configuration
process.env.NODE_ENV = process.env.NODE_ENV || 'testing';

var path = require('path');

var Server = require('../server/server.js');
var config = require('konphyg')(path.normalize(__dirname + '/../config'));
var Registry = require('../lib/registry');

console.log('Loading ' + process.env.NODE_ENV + ' configuration data');

var cfg = config(process.env.NODE_ENV);

// server setup
var registry = new Registry(cfg);
var server = new Server(registry, cfg.app);

// server components
var rootRoutes = require('../lib/routes/root.js');
var packageRoutes = require('../lib/routes/package.js');
var userRoutes = require('../lib/routes/user.js');

server.applyRoutes(rootRoutes);
server.applyRoutes(packageRoutes, registry);
server.applyRoutes(userRoutes, registry);

server.start(cfg);
